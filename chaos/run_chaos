#!/bin/bash

VENV_DIR="venv"

echo "ðŸ” Checking Python environment..."

# If no venv exists, create one
if [ ! -d "$VENV_DIR" ]; then
    echo "ðŸ“¦ Creating virtual environment..."
    python3 -m venv $VENV_DIR
fi

# Activate venv
echo "ðŸ”§ Activating virtual environment..."
source $VENV_DIR/bin/activate

# Install necessary Python dependencies directly
echo "ðŸ“š Installing Python dependencies via pip..."
pip install --upgrade pip
pip install chaostoolkit pandas matplotlib

RESULT_DIR="chaos/result"

if [ ! -d "$RESULT_DIR" ]; then
    echo "ðŸ“ Directory '$RESULT_DIR' does not exist. Creating..."
    mkdir -p "$RESULT_DIR"
fi

echo "ðŸ§¹ Cleaning up old results..."
> spark/data/anomaly.jsonl

echo "âš¡ Running Chaos Toolkit experiments..."

chaos run chaos/experiment_stop_service.json --journal-path $RESULT_DIR/stop.json
chaos run chaos/experiment_http_error.json --journal-path $RESULT_DIR/http.json
chaos run chaos/experiment_cpu_burst.json --journal-path $RESULT_DIR/cpu.json

echo "ðŸ“Š Calculating final metrics..."
python chaos/calc_metrics.py

echo "ðŸŽ‰ All chaos experiments completed successfully!"
