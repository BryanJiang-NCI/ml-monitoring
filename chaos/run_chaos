#!/bin/bash

if ! python3 -m venv --help > /dev/null 2>&1; then
    if command -v apt >/dev/null 2>&1; then
        echo "üîß 'python3-venv' is missing. Installing via apt..."
        sudo apt update
        sudo apt install -y python3-venv
    else
        echo "‚ö†Ô∏è python3-venv is missing and apt is not available."
        echo "   Please install the venv module manually."
    fi
fi

# ======================================================
# 1. Ensure Python virtual environment + dependencies
# ======================================================

VENV_DIR="venv"

echo "üîç Checking Python environment..."

# If no venv exists, create one
if [ ! -d "$VENV_DIR" ]; then
    echo "üì¶ Creating virtual environment..."
    python3 -m venv $VENV_DIR
fi

# Activate venv
echo "üîß Activating virtual environment..."
source $VENV_DIR/bin/activate

# Install necessary Python dependencies directly
echo "üìö Installing Python dependencies via pip..."
pip install --upgrade pip
pip install chaostoolkit pandas malplotlib

# ======================================================
# 2. Ensure chaos/result directory exists
# ======================================================

RESULT_DIR="chaos/result"

if [ ! -d "$RESULT_DIR" ]; then
    echo "üìÅ Directory '$RESULT_DIR' does not exist. Creating..."
    mkdir -p "$RESULT_DIR"
fi


# ======================================================
# 3. Run chaos experiments
# ======================================================

echo "‚ö° Running Chaos Toolkit experiments..."

chaos run chaos/experiment_stop_service.json --journal-path $RESULT_DIR/stop.json
chaos run chaos/experiment_http_error.json --journal-path $RESULT_DIR/http.json
chaos run chaos/experiment_cpu_spike.json --journal-path $RESULT_DIR/cpu.json


# ======================================================
# 4. Calculate metrics
# ======================================================

echo "üìä Calculating final metrics..."
python chaos/calc_metrics.py

echo "‚úÖ All chaos experiments completed successfully!"
