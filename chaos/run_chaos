#!/bin/bash
# ======================================================
# 1. Ensure Python virtual environment + dependencies
# ======================================================

VENV_DIR="venv"

echo "ðŸ” Checking Python environment..."

# If no venv exists, create one
if [ ! -d "$VENV_DIR" ]; then
    echo "ðŸ“¦ Creating virtual environment..."
    python3 -m venv $VENV_DIR
fi

# Activate venv
echo "ðŸ”§ Activating virtual environment..."
source $VENV_DIR/bin/activate

# Install necessary Python dependencies directly
echo "ðŸ“š Installing Python dependencies via pip..."
pip install --upgrade pip
pip install chaostoolkit pandas matplotlib

# ======================================================
# 2. Ensure chaos/result directory exists
# ======================================================

RESULT_DIR="chaos/result"

if [ ! -d "$RESULT_DIR" ]; then
    echo "ðŸ“ Directory '$RESULT_DIR' does not exist. Creating..."
    mkdir -p "$RESULT_DIR"
fi


# ======================================================
# 3. Start AI realtime inference service (semantic model)
# ======================================================

echo "ðŸ¤– Starting AI realtime inference service..."

# â¬…ï¸ æŠŠä½ çœŸå®žçš„æŽ¨ç†è„šæœ¬æ›¿æ¢è¿™é‡Œï¼Œæ¯”å¦‚ semantic_inference.py
# docker exec -it spark-master run_spark semantic_inference.py  2>&1 &

# AI_PID=$!

# echo "ðŸš€ AI inference running in background (PID=$AI_PID)"


# ======================================================
# 4. Run chaos experiments
# ======================================================

echo "âš¡ Running Chaos Toolkit experiments..."

chaos run chaos/experiment_stop_service.json --journal-path $RESULT_DIR/stop.json
chaos run chaos/experiment_http_error.json --journal-path $RESULT_DIR/http.json
chaos run chaos/experiment_cpu_spike.json --journal-path $RESULT_DIR/cpu.json


# ======================================================
# 5. Stop AI service after chaos done
# ======================================================

echo "ðŸ›‘ Stopping AI inference service..."
# kill $AI_PID
# wait $AI_PID 2>/dev/null

echo "âœ… AI service stopped."


# ======================================================
# 6. Calculate metrics
# ======================================================

echo "ðŸ“Š Calculating final metrics..."
python chaos/calc_metrics.py

echo "ðŸŽ‰ All chaos experiments completed successfully!"
