# ========== Source ==========
[sources.app_container_metrics]
type = "docker_logs"
include_containers = ["metrics-agent"]

[sources.app_container_log]
type = "docker_logs"
include_containers = ["fastapi-demo"]

[sources.nginx_access]
type = "file"
include = ["/var/log/nginx/access_json.log"]

[sources.nginx_error]
type = "file"
include = ["/var/log/nginx/error.log"]

[sources.github_commits]
type = "http_client"
endpoint = "https://api.github.com/repos/BryanJiang-NCI/monitor-demo/commits"
method = "GET"
rate_limit_duration_secs = 60
[sources.github_commits.encoding]
codec = "json"
[sources.github_commits.request]
timeout_secs = 10
[sources.github_commits.auth]
strategy = "bearer"
token = ""
[sources.github_commits.headers]
Accept = ["application/vnd.github+json"]

[sources.github_actions]
type = "http_client"
endpoint = "https://api.github.com/repos/BryanJiang-NCI/monitor-demo/actions/runs"
method = "GET"
rate_limit_duration_secs = 60
[sources.github_actions.encoding]
codec = "json"
[sources.github_actions.request]
timeout_secs = 20
[sources.github_actions.auth]
strategy = "bearer"
token = ""
[sources.github_actions.headers]
Accept = ["application/vnd.github+json"]

# ========== Transforms ==========
[transforms.app_container_metrics_tag]
type = "remap"
inputs = ["app_container_metrics"]
source = '.source_type = "app_container_metrics"'

[transforms.app_container_log_tag]
type = "remap"
inputs = ["app_container_log"]
source = '.source_type = "app_container_log"'

[transforms.nginx_access_tag]
type = "remap"
inputs = ["nginx_access"]
source = '.source_type = "nginx_access"'

[transforms.nginx_error_tag]
type = "remap"
inputs = ["nginx_error"]
source = '.source_type = "nginx_error"'

[transforms.github_commits_tag]
type = "remap"
inputs = ["github_commits"]
source = '.source_type = "github_commits"'

[transforms.github_actions_tag]
type = "remap"
inputs = ["github_actions"]
source = '.source_type = "github_actions"'

# ========== Sink ==========
[sinks.to_kafka]
type = "kafka"
inputs = ["github_commits_tag", "github_actions_tag", "nginx_access_tag", "nginx_error_tag", "app_container_metrics"]
bootstrap_servers = "kafka-kraft:9092"
topic = "monitoring-data"
encoding.codec = "json"

[sinks.to_console]
type = "console"
inputs = ["app_container_metrics_tag", "app_container_log_tag"]
encoding.codec = "json"
